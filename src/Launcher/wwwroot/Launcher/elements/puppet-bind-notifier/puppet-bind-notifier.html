<!--
Element: puppet-bind-notifier
-->


<link href="/sys/polymer/polymer.html" rel="import">

<dom-module id="puppet-bind-notifier">

<template strip-whitespace>
	<style>
		:host {
			display: none;
		}
	</style>
</template>

<script type="text/javascript">(function() {
  Polymer({
    is: 'puppet-bind-notifier',
    _isAttached: false,
    properties: {
      ref: {
        type: String,
        observer: '_refChanged'
      },
	  path: {
		  type: String,
		  value: "",
	  },
	  _ref: {
		  type: Object,
		  value: null,
	  },
	  _puppet: {
		  type: Object,
		  value: null,
	  },
    },
	observers: [
		'_loaded(_puppet, _ref)',
	],
    attached: function() {
      this._isAttached = true;
	  this._stamp();
    },
    detached: function() {
      this._isAttached = false;
    },
    _refChanged: function(newRef, oldRef) {
		if (oldRef) {
          return this._stamp();
        }
    },
    _puppetClientChanged: function(newClient, oldClient) {
		if (oldClient) {
			return this._stamp();
		}
    },
    _stamp: function() {
      var root, template, templateRoot;

      if(this.ref){
        root = Polymer.dom(this).parentNode;
        while (Polymer.dom(root).parentNode) {
          root = Polymer.dom(root).parentNode;
        }
        template = Polymer.dom(root).querySelector("template#" + this.ref);
        if (!template) {
          template = document.querySelector("template#" + this.ref);
          if(!template){
              throw "There is no template#" + this.ref;
          }
        }
      } else {
        template = this.nextElementSibling;
        while(template && template.tagName != "TEMPLATE"){
          template = template.nextElementSibling;
        }
        if(!template){
            throw "There is no next `<template>` sibling.";
        }
      }
      this.set('_ref', template);
	  if (!this._puppet)
	  {
		  this.set('_puppet', document.querySelector("puppet-client"));
  	  }
    },
	_loaded: function(puppet, template)
	{
		if (puppet)
		{

			puppet.addEventListener("patchesapplied", this._patchesApplied.bind(this));
		}
	},
	_sendBasicNotifies: function()
	{
		if (this._puppet)
		{
			for (var property in this._puppet.obj) {
			  if (this._puppet.obj.hasOwnProperty(property)) {
				  this._ref.notifyPath('model.' + property, this._puppet.obj[property]);
			  }
			}
		};
	},
	_patchesApplied: function (ev)
	{
		var patches = ev.detail.data;
		patches.forEach(this._patchApplied.bind(this));
		console.log(patches);
	},
	_patchApplied: function(patch)
	{
		if (patch.op == 'test' && patch.value == 0)
			this._sendBasicNotifies();
		else if (patch.op == 'replace')
		{
			this._notifyTemplate(patch);
		}
	},
	_notifyTemplate: function(patch)
	{
		  var path = 'model' + this._translatePath(patch.path);
		  this._ref.notifyPath(path, patch.value);
	},
	_translatePath : function(path){
	  return path.split("/").join(".");
    },
    _observer_array: function(arr){
        this.template._notifySplice(change.object, this.path + getPath(this.observedObject, change.object), change.index, change.addedCount, change.removed);
        this.template._notifySplice(change.object, this.path + getPath(this.observedObject, change.object), parseInt(change.name), 1, [change.oldValue]);
        notifyTemplate(this, change);
    },
  });


  function _getPathRecursive(root, obj) {
      var found;
      for (var key in root) {
          if (root.hasOwnProperty(key)) {
              if (root[key] === obj) {
                  return '.' + key;
              } else if (typeof root[key] === 'object') {
                  found = _getPathRecursive(root[key], obj);
                  if (found !== false) {
                      return '.' + key + found;
                  }
              }
          }
      }
      return false;
  }

  function getPath(root, obj) {
      if (root === obj) {
          return '';
      }
      var path = _getPathRecursive(root, obj);
      if (path === false) {
          throw new OriginalError("Object not found in root");
      }
      return path;
  }



  function isNormalInteger(str) {
    var n = ~~Number(str);
    return String(n) === str && n >= 0;
  }


  var _isArray;
  if (Array.isArray) {
    _isArray = Array.isArray;
  } else {
    _isArray = function (obj) {
        return obj.push && typeof obj.length === 'number';
    };
  }

}());
</script>

</dom-module>
