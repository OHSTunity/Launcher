<!--
`launcher-root-partial` - Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
It's just <template is="imported-template"> wrapped within <juicy-tiles> and layout editor.

Uses name attribute to assign identifier for juicy-tiles setup in DB.
@TODO(tomalec): fetch it automatically from binded
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<link rel="import" href="/sys/imported-template/imported-template.html">
<link rel="import" href="/sys/juicy-tile-grid/src/juicy-tile-grid.html">
<link rel="import" href="/sys/juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="/sys/console-log/console-log.html"> -->

<template id="partial-template">
  <template bind>
    <!-- FIXME: one-way binding here is temporary workaround for servers not accepting JSON-Patch (tomalec) -->
    <juicy-tiles-setup-sync 
        name="{{__Launcher.PartialId}}" 
        storedValue="[[__Launcher.juicyTilesSetup]]" 
        apiUrl="/launcher/juicytilessetup"></juicy-tiles-setup-sync>
    <juicy-tile-grid 
        id="{{__Launcher.PartialId}}" 
        name="{{__Launcher.PartialId}}"
        setup="[[ __Launcher.juicyTilesSetup | clonedSetup  ]]"
        defaultTileSetup="{
            'heightAuto': true,
            'width': '100%',
            'heightDynamic': true
        }">
      <template is="imported-template" content="{{Html}}"></template>
  </juicy-tile-grid>
   <!-- unfortunately [[ obj ]] does not work deep (for nested properties) sp we need clonedSetup-->
  </template>
</template>
<script>
  (function () {


    var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");

    // var templateAttribute = {
    //   'repeat': true,
    //   'bind': true,
    //   'if': true
    // };
    // function rewriteTempalteAttributes(from, to){      
    //   var attribs = from.attributes;
    //   var count = attribs.length;
    //   while (count-- > 0) {
    //     var attrib = attribs[count];
    //     if (templateAttribute[attrib.name]) {
    //       if (attrib.name !== 'template')
    //         to.setAttribute(attrib.name, attrib.value);
    //       from.removeAttribute(attrib.name);
    //     }
    //   }
    // }

    function inDocumentFragment(element){
      var parent = element.parentNode;
      while( parent && !(parent instanceof DocumentFragment) ){
        parent = parent.parentNode;
      }
      return parent instanceof DocumentFragment;
    }

    var LauncherPartialPrototype = Object.create(HTMLElement.prototype);

    /**
     * Use predefined template content, rewrite attributes.
     */
    LauncherPartialPrototype.createdCallback = function LPartialCreated(){
      // ugly https://code.google.com/p/chromium/issues/detail?id=430578 workaround
      if( inDocumentFragment( this ) ){
        return ;
      }
      var sroot = this.createShadowRoot();
      sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

      var clone = document.importNode( templ.content, true);
      var innerTempl = clone.querySelector("template");
      innerTempl.bindingDelegate = new PolymerExpressions();
      innerTempl.bindingDelegate.clonedSetup = {
        toDOM: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        },
        toModel: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        }
      };
      // rewriteTempalteAttributes( this, innerTempl );
      this.innerTempl = innerTempl;
      this.appendChild( clone );
    };
    /**
     * Attach model.
     */
    LauncherPartialPrototype.attachedCallback = function LPartialAttached(){
      var model = this.innerTempl.templateInstance.model;
      var that = this;
      
      // Mock desired Launcher scope
      model.__Launcher = model.__Launcher || {};
      !model.PartialId && console.warn("PartialId for", this, "is missing");
      model.__Launcher.PartialId = this.getAttribute("name") || model.PartialId;
      if(!model.__Launcher.PartialId){
        console.warn("Custom name for partial", this, "is also missing");
        console.info("trying to build something from parent .Html");
        model.__Launcher.PartialId = getParentHtml(model);
      }


      if(model.juicyTilesSetup){
        model.__Launcher.juicyTilesSetup = model.juicyTilesSetup;
        this.innerTempl.model = model;
      } else {
        // workaround for lack of consistent server-side support for merged-partials (tomalec)
        var req = new XMLHttpRequest();
        req.onload = function () {
          var res = this;
          if(res.status == 404){
            model.__Launcher.juicyTilesSetup = null;
          } else if (res.status >= 400 && res.status <= 599) {
            console.error("Failed to delete juicy-tile-list configuration" 
                + res.status + ' ' + res.statusText + '\n\n' + res.responseText);
          } else {
            model.__Launcher.juicyTilesSetup = res.responseText && JSON.parse( res.responseText ) || null; 
          }
          that.innerTempl.model = model;
        };
        req.open("GET", "/launcher/juicytilessetup?" + model.__Launcher.PartialId, true);
        req.send();
      }
      
      // this.innerTempl.model = model;
      // // this.innerTempl.model = this.templateInstance.model;
      // //
      // // this.innerTempl.model = this.innerTempl.templateInstance ?
      // //     this.innerTempl.templateInstance.model :
      // //     this.templateInstance.model;
    };

    function getParentHtml(model){
      var parent = model;
      // workaround for lack of consistent server-side support for merged-partials (tomalec)
        parent=parent.$parent;
      while(parent && !parent.Html){
        parent = parent.$parent;
      }
      return parent && parent.Html || "";
    }


    document.registerElement('launcher-root-partial', {
      prototype: LauncherPartialPrototype
    });   
  })();
</script>
