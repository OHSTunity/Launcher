<!--
`launcher-root-partial` - Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<link rel="import" href="../../sys/imported-template/imported-template.html">
<link rel="import" href="../../sys/juicy-tile-grid/src/juicy-tile-grid.html">
<link rel="import" href="../../sys/juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="../../sys/console-log/console-log.html"> -->

<template id="partial-template">
  <template bind>
    <!-- FIXME: one-way binding here is temporary workaround for servers not accepting JSON-Patch (tomalec) -->
    <juicy-tiles-setup-sync name="{{Html}}" storedValue="[[_setup]]" ></juicy-tiles-setup-sync>
    <juicy-tile-grid 
        id="juicy-tile:{{Html}}" 
        setup="[[ _setup | clonedSetup  ]]"
        defaultTileSetup="{
            'heightAuto': true,
            'width': '100%',
            'heightDynamic': true
        }">
      <template is="imported-template" content="{{Html}}"></template>
  </juicy-tile-grid>
   <!-- unfortunately [[ obj ]] does not work deep (for nested properties) sp we need clonedSetup-->
  </template>
</template>
<script>
  (function () {


    var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");

    var templateAttribute = {
      'repeat': true,
      'bind': true,
      'if': true
    };
    function rewriteTempalteAttributes(from, to){      
      var attribs = from.attributes;
      var count = attribs.length;
      while (count-- > 0) {
        var attrib = attribs[count];
        if (templateAttribute[attrib.name]) {
          if (attrib.name !== 'template')
            to.setAttribute(attrib.name, attrib.value);
          from.removeAttribute(attrib.name);
        }
      }
    }

    var LauncherPartialPrototype = Object.create( (HTMLTemplateElement || HTMLElement ).prototype);

    /**
     * Use predefined template content, rewrite attributes.
     */
    LauncherPartialPrototype.createdCallback = function LPartialCreated(){
      // this.style.display = "block";
      var sroot = this.createShadowRoot();
      sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

      var clone = document.importNode( templ.content, true);
      rewriteTempalteAttributes( this, clone.querySelector("template") );
      this.appendChild( clone );
      // return (HTMLTemplateElement || HTMLElement ).prototype.createdCallback.apply(this, arguments);
    };
    /**
     * Attach model.
     */
    LauncherPartialPrototype.attachedCallback = function LPartialAttached(){
      var innerTempl = this.getElementsByTagName("template")[0];
      innerTempl.bindingDelegate = new PolymerExpressions();
      innerTempl.bindingDelegate.clonedSetup = {
        toDOM: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        },
        toModel: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        }
      }

      innerTempl.model = this.templateInstance.model;
      // return (HTMLTemplateElement || HTMLElement ).prototype.createdCallback.apply(this, arguments);
    };


    document.registerElement('launcher-root-partial', {
      prototype: LauncherPartialPrototype
    });   
  })();
</script>
